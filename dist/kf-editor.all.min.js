/*!
 * ====================================================
 * Kityformula-Editor - v1.0.0 - 2014-04-14
 * https://github.com/kitygraph/formula
 * GitHub: https://github.com/kitygraph/formula.git 
 * Copyright (c) 2014 Baidu Kity Group; Licensed MIT
 * ====================================================
 */
!function(){function a(a,b,c){if(d[a]={exports:{},value:null,factory:null},2===arguments.length&&(c=b),"[object Object]"===d.toString.call(c))d[a].value=c;else{if("function"!=typeof c)throw new Error("define函数未定义的行为");d[a].factory=c}}function b(a){var c=d[a],e=null;return c?c.value?c.value:(e=c.factory.call(null,b,c.exports,c),e&&(c.exports=e),c.value=c.exports,c.value):null}function c(a){return b(a)}var d={};a("base/common",[],function(){function a(d,e,f,g){return g=0|g,g>b?f:(g++,c.each(f,function(b,f){d?!b||"object"!=typeof b&&"function"!=typeof b?e[f]=b:(e[f]=e[f]||(c.isArray(b)?[]:{}),e[f]=a(d,e[f],b,g)):e[f]=b}),e)}var b=10,c={extend:function(b,d){var e=!1;if("boolean"==typeof b?(e=b,b=d,d=[].splice.call(arguments,2)):d=[].splice.call(arguments,1),!b)throw new Error("Utils: extend, target can not be empty");return c.each(d,function(c){(c&&"object"==typeof c||"function"==typeof c)&&a(e,b,c)}),b},isArray:function(a){return a&&"[object Array]"==={}.toString.call(a)},isString:function(a){return"string"==typeof a},proxy:function(a,b){return function(){return a.apply(b,arguments)}},each:function(a,b){if(a)if("length"in a&&"number"==typeof a.length)for(var c=0,d=a.length;d>c&&b.call(null,a[c],c,a)!==!1;c++);else for(var e in a)if(a.hasOwnProperty(e)&&b.call(null,a[e],e,a)===!1)break}};return c}),a("base/event/event",["base/event/kfevent","base/common"],function(a){function b(){return++d}var c={},d=0,e=!0,f=a("base/event/kfevent"),g=a("base/common"),h=function(a){var b=a.type,d=a.target,f=this.__kfe_eid,h=/^(?:before|after)/.test(b),j=c[f][b];return h||(i.trigger(d,"before"+b),e!==!1)?(g.each(j,function(b){return b&&b.call(d,a)===!1?e=!1:void 0}),void(h||i.trigger(d,"after"+b))):(e=!0,!1)},i={addEvent:function(a,d,e){var f=!0,g=null;a.__kfe_eid||(f=!1,a.__kfe_eid=b(),c[a.__kfe_eid]={}),g=c[a.__kfe_eid],g[d]||(f=!1,g[d]=[]),g[d].push(e),f||a.addEventListener(d,h,!1)},trigger:function(a,b,c){c=c||f.createEvent(b,c),a.dispatchEvent(c)}};return i}),a("base/event/kfevent",[],function(){return{createEvent:function(a){var b=document.createEvent("Event");return b.initEvent(a,!0,!0),b}}}),a("base/utils",["base/common","base/event/event","base/event/kfevent"],function(a){var b={},c=a("base/common");return c.extend(b,c,a("base/event/event")),b}),a("editor/editor",["kity","base/utils","base/common","base/event/event"],function(a){function b(a){var b=this.services[a];if(!b)throw new Error("KFEditor: not found service, "+a);return b}var c=a("kity"),d=a("base/utils"),e={controller:{zoom:!0,maxzoom:5,minzoom:.5},formula:{fontsize:50,autoresize:!1}},f={},g=c.createClass("KFEditor",{constructor:function(a,b){this.options=d.extend(!0,{},e,b),this.container=a,this.services={},this.commands={},this.initComponents()},getContainer:function(){return this.container},getOptions:function(){return this.options},initComponents:function(){var a=this;d.each(f,function(b){new b(a)})},requestService:function(a){var c=b.call(this,a);return c.service[c.key].apply(c.provider,[].slice.call(arguments,1))},request:function(a){var c=b.call(this,a);return c.service},registerService:function(a,b,c){var e=null;for(e in c)c[e]&&c.hasOwnProperty(e)&&(c[e]=d.proxy(c[e],b));this.services[a]={provider:b,key:e,service:c}},registerCommand:function(a,b,c){this.commands[a]={executor:b,execFn:c}},execCommand:function(a){var b=this.commands[a];if(!b)throw new Error("KFEditor: not found command, "+a);return b.execFn.apply(b.executor,[].slice.call(arguments,1))}});return d.extend(g,{registerComponents:function(a,b){f[a]=b}}),g}),a("jquery",[],function(){return window.jQuery}),a("kf-ext/def",[],function(){return{selectColor:"rgba(42, 106, 189, 0.2)",allSelectColor:"rgba(42, 106, 189, 0.6)"}}),a("kf-ext/expression/placeholder",["kity","kf","kf-ext/operator/placeholder","kf-ext/def"],function(a){var b=a("kity"),c=a("kf"),d=a("kf-ext/operator/placeholder");return b.createClass("PlaceholderExpression",{base:c.CompoundExpression,constructor:function(){this.callBase(),this.setFlag("Placeholder"),this.box.setAttr("data-type",null),this.setOperator(new d)},select:function(){this.getOperator().select()},selectAll:function(){this.getOperator().selectAll()},unselect:function(){this.getOperator().unselect()}})}),a("kf-ext/extension",["kf","kity","kf-ext/def","kf-ext/expression/placeholder","kf-ext/operator/placeholder"],function(a){function b(b){c.PlaceholderExpression=a("kf-ext/expression/placeholder"),c.Expression.prototype.select=function(){this.box.fill(d)},c.Expression.prototype.selectAll=function(){this.box.fill(e)},c.Expression.prototype.unselect=function(){this.box.fill("transparent")},b.getKFParser().expand({parse:{placeholder:{name:"placeholder",handler:function(a){return delete a.handler,a.operand=[],a},sign:!1}},reverse:{placeholder:function(){return"\\placeholder"}}})}var c=a("kf"),d=(a("kity"),a("kf-ext/def").selectColor),e=a("kf-ext/def").allSelectColor;return{ext:b}}),a("kf-ext/operator/placeholder",["kity","kf-ext/def","kf"],function(a){function b(){var a=13,b=17,d=null;return d=new c.Rect(a,b,0,0).stroke("black").fill("transparent").translate(2,6),d.setAttr("stroke-dasharray","1, 2"),d}var c=a("kity"),d=a("kf-ext/def").selectColor,e=a("kf-ext/def").allSelectColor;return c.createClass("PlaceholderOperator",{base:a("kf").Operator,constructor:function(){this.opShape=null,this.callBase("Placeholder")},applyOperand:function(){this.setBoxSize(17,27),this.opShape=b(),this.addOperatorShape(this.opShape)},select:function(){this.opShape.fill(d)},selectAll:function(){this.opShape.fill(e)},unselect:function(){this.opShape.fill("transparent")}})}),a("kf",[],function(){return window.kf}),a("kity",[],function(){return window.kity}),a("parse/def",[],function(){return{radical:!0,fraction:!0,summation:!0,integration:!0,placeholder:!0,script:!0,superscript:!0,subscript:!0,brackets:!0}}),a("parse/parser",["kf","kity","parse/def","kf-ext/extension","kf-ext/def","kf-ext/expression/placeholder"],function(a){function b(a,c,d){var e=null,g=!d;c.attr=c.attr||{},c.attr.id=a.getGroupId(),c.attr["data-type"]||(c.attr["data-type"]=h,f[c.name]&&(c.attr["data-type"]=i)),g&&(a.isResetId?c.attr["data-root"]="true":c.attr["data-type"]=i),"brackets"===c.name&&(c.attr["data-brackets"]="true");for(var j=0,k=c.operand.length;k>j;j++)e=c.operand[j],e?f[c.name]?"string"==typeof e?("brackets"!==c.name||j>1)&&(c.operand[j]={name:"combination",operand:[e],attr:{id:a.getGroupId(),"data-type":h}}):"combination"!==e.name?(c.operand[j]={name:"combination",operand:[null],attr:{id:a.getGroupId(),"data-type":h}},"placeholder"===e.name?(c.operand[j].operand[0]={name:"combination",operand:[e],attr:{id:a.getGroupId(),"data-type":h,"data-placeholder":"true"}},e.attr={id:a.getGroupId()}):c.operand[j].operand[0]=b(a,e,c.operand[j])):(e.attr={"data-type":h},c.operand[j]=b(a,e,c)):"string"==typeof e?c.operand[j]=e:"placeholder"===e.name?(c.operand[j]={name:"combination",operand:[e],attr:{id:a.getGroupId(),"data-type":h,"data-placeholder":"true"}},e.attr={id:a.getGroupId()}):c.operand[j]=b(a,e,c):c.operand[j]=e;return c}function c(){return g+ ++j}var d=a("kf").Parser,e=a("kity"),f=a("parse/def"),g="_kf_editor_",h="kf-editor-group",i="kf-editor-virtual-group",j=0,k=e.createClass("Parser",{constructor:function(a){this.kfEditor=a,this.callBase(),this.kfParser=d.use("latex"),this.initKFormulExtension(),this.pid=c(),this.groupRecord=0,this.tree=null,this.isResetId=!0,this.initServices()},parse:function(a,c){var d=null;return this.isResetId=!!c,this.isResetId&&this.resetGroupId(),d=this.kfParser.parse(a),b(this,d.tree),d},serialization:function(a){return this.kfParser.serialization(a)},initServices:function(){this.kfEditor.registerService("parser.parse",this,{parse:this.parse}),this.kfEditor.registerService("parser.latex.serialization",this,{serialization:this.serialization})},getKFParser:function(){return this.kfParser},initKFormulExtension:function(){a("kf-ext/extension").ext(this)},resetGroupId:function(){this.groupRecord=0},getGroupId:function(){return this.pid+"_"+ ++this.groupRecord}});return k}),a("position/position",["kity"],function(a){function b(a,c,d){var e=null;return a.ownerSVGElement?(a=a.parentNode,e=a.tagName.toLowerCase(),a&&"body"!==e&&"svg"!==e?"kf-editor-group"===a.getAttribute("data-type")?a:c&&"kf-editor-virtual-group"===a.getAttribute("data-type")?a:d&&null!==a.getAttribute("data-flag")?a:b(a,c,d):null):null}var c=a("kity"),d=c.createClass("PositionComponenet",{constructor:function(a){this.kfEditor=a,this.initServices()},initServices:function(){this.kfEditor.registerService("position.get.group",this,{getGroupByTarget:this.getGroupByTarget}),this.kfEditor.registerService("position.get.parent.group",this,{getParentGroupByTarget:this.getParentGroupByTarget}),this.kfEditor.registerService("position.get.wrap",this,{getWrap:this.getWrap}),this.kfEditor.registerService("position.get.group.info",this,{getGroupInfoByNode:this.getGroupInfoByNode}),this.kfEditor.registerService("position.get.parent.info",this,{getParentInfoByNode:this.getParentInfoByNode})},getGroupByTarget:function(a){var c=b(a,!1,!1);return c?this.kfEditor.requestService("syntax.get.group.content",c.id):null},getParentGroupByTarget:function(a){var c=b(a,!0,!1);return c?this.kfEditor.requestService("syntax.get.group.content",c.id):null},getWrap:function(a){return b(a,!0,!0)},getGroupInfoByNode:function(a){var c=null,d=null;for(d=a;(a=b(a,!0,!1))&&"kf-editor-group"!==a.getAttribute("data-type");)d=a;return c={group:this.kfEditor.requestService("syntax.get.group.content",a.id)},c.index=c.group.content.indexOf(d),c},getParentInfoByNode:function(a){var c=b(a,!0,!1);return c=this.kfEditor.requestService("syntax.get.group.content",c.id),{group:c,index:c.content.indexOf(a)}}});return d}),a("render/render",["kity","kf"],function(a){var b=a("kity"),c=a("kf").Assembly,d={autoresize:!1,fontsize:30,padding:[20,50]},e=b.createClass("RenderComponent",{constructor:function(a){this.kfEditor=a,this.assembly=null,this.formula=null,this.canvasZoom=1,this.record={select:{},cursor:{}},this.initCanvas(),this.initServices(),this.initCommands()},initCanvas:function(){var a=this.kfEditor.requestService("ui.get.canvas.container");this.assembly=c.use(a,d),this.formula=this.assembly.formula},initServices:function(){this.kfEditor.registerService("render.relocation",this,{relocation:this.relocation}),this.kfEditor.registerService("render.select.group.content",this,{selectGroupContent:this.selectGroupContent}),this.kfEditor.registerService("render.select.group",this,{selectGroup:this.selectGroup}),this.kfEditor.registerService("render.select.group.all",this,{selectAllGroup:this.selectAllGroup}),this.kfEditor.registerService("render.select.current.cursor",this,{selectCurrentCursor:this.selectCurrentCursor}),this.kfEditor.registerService("render.reselect",this,{reselect:this.reselect}),this.kfEditor.registerService("render.clear.select",this,{clearSelect:this.clearSelect}),this.kfEditor.registerService("render.set.canvas.zoom",this,{setCanvasZoom:this.setCanvasZoom}),this.kfEditor.registerService("render.get.canvas.zoom",this,{getCanvasZoom:this.getCanvasZoom}),this.kfEditor.registerService("render.get.paper.offset",this,{getPaperOffset:this.getPaperOffset}),this.kfEditor.registerService("render.draw",this,{render:this.render}),this.kfEditor.registerService("render.insert.string",this,{insertString:this.insertString}),this.kfEditor.registerService("render.insert.group",this,{insertGroup:this.insertGroup}),this.kfEditor.registerService("render.get.paper",this,{getPaper:this.getPaper})},initCommands:function(){this.kfEditor.registerCommand("render",this,this.render),this.kfEditor.registerCommand("getPaper",this,this.getPaper)},relocation:function(){var a=this.formula.container.getRenderBox(),b=this.formula.getViewPort();b.center.x=a.width/2,b.center.y=a.height/2,this.formula.setViewPort(b)},selectGroup:function(a){var b=this.kfEditor.requestService("syntax.get.group.object",a),c=this.kfEditor.requestService("syntax.valid.placeholder",a);this.clearSelect(),b.node.getAttribute("data-root")||(c&&(b=this.kfEditor.requestService("syntax.get.group.object",b.operands[0].node.id)),this.record.select.lastSelect=b,b.select())},selectGroupContent:function(a){null!==a.groupObj.getAttribute("data-placeholder")&&(a={id:a.content[0].id});var b=this.kfEditor.requestService("syntax.get.group.object",a.id);this.clearSelect(),this.record.select.lastSelect=b,b.node.getAttribute("data-root")||b.select()},selectAllGroup:function(a){null!==a.groupObj.getAttribute("data-placeholder")&&(a={id:a.content[0].id});var b=this.kfEditor.requestService("syntax.get.group.object",a.id);this.clearSelect(),this.record.select.lastSelect=b,b.selectAll()},selectCurrentCursor:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor"),b=this.kfEditor.requestService("syntax.get.group.object",a.groupId),c=null,d=-1,e=0,f=b.getRenderBox().height,g=Math.min(a.startOffset,a.endOffset),h=Math.max(a.startOffset,a.endOffset);this.clearSelect(),this.record.select.lastSelect=b;for(var i=g,j=h;j>i;i++)c=b.getOperand(i).getRenderBox(),-1==d&&(d=c.x),e+=c.width;b.setBoxSize(e,f),b.selectAll(),b.getBox().translate(d,0)},reselect:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor"),b=null;b=this.kfEditor.requestService("syntax.get.group.object",a.groupId),this.clearSelect(),this.record.select.lastSelect=b,b.node.getAttribute("data-root")||b.select()},clearSelect:function(){var a=null,b=null,c=this.record.select.lastSelect;c&&(c.unselect(),a=c.getRenderBox(),c.setBoxSize(a.width,a.height),b=c.getBox().getTransform(),b&&(b.m.e=0,b.m.f=0),c.getBox().setTransform(b))},getPaper:function(){return this.formula},render:function(a){var b=this.kfEditor.requestService("parser.parse",a,!0),c=this.assembly.regenerateBy(b);this.kfEditor.requestService("syntax.update.objtree",c),this.relocation()},setCanvasZoom:function(a){var b=this.formula.getViewPort();this.canvasZoom=a,b.zoom=a,this.formula.setViewPort(b)},getCanvasZoom:function(){return this.canvasZoom}});return e}),a("syntax/move",["kity"],function(a){function b(a){var b=null,c=this.parentComponent,f=null;if(a.startOffset===a.endOffset){if(f=c.getGroupContent(a.groupId),m(f.groupObj))return e(this,f.groupObj,p.LEFT);a.startOffset>0?(b=f.content[a.startOffset-1],l(b)?a=d(this,b,p.LEFT):(a.startOffset-=1,a.endOffset=a.startOffset)):a=e(this,f.groupObj,p.LEFT)}else a.startOffset=Math.min(a.startOffset,a.endOffset),a.endOffset=a.startOffset;return a}function c(a){var b=null,c=this.parentComponent,f=null;if(a.startOffset===a.endOffset){if(f=c.getGroupContent(a.groupId),m(f.groupObj))return e(this,f.groupObj,p.RIGHT);a.startOffset<f.content.length?(b=f.content[a.startOffset],l(b)?a=d(this,b,p.RIGHT):(a.startOffset+=1,a.endOffset=a.startOffset)):a=e(this,f.groupObj,p.RIGHT)}else a.endOffset=Math.max(a.startOffset,a.endOffset),a.startOffset=a.endOffset;return a}function d(a,b,c){switch(c){case p.LEFT:return f(a,b);case p.RIGHT:return h(a,b)}throw new Error("undefined move direction!")}function e(a,b,c){switch(c){case p.LEFT:return g(a,b);case p.RIGHT:return i(a,b)}throw new Error("undefined move direction!")}function f(a,b){var c=a.parentComponent,d=null,e=null;if(m(b)||n(b))return g(a,b);if(l(b)){if(d=c.getGroupContent(b.id),e=d.content[d.content.length-1],n(e))return g(a,e);if(k(b))return m(e)?{groupId:e.id,startOffset:0,endOffset:0}:k(e)&&1===d.content.length?f(a,e):{groupId:b.id,startOffset:d.content.length,endOffset:d.content.length};for(;!k(e)&&!n(e)&&!m(e);)d=c.getGroupContent(e.id),e=d.content[d.content.length-1];return n(e)?g(a,e):m(e)?{groupId:e.id,startOffset:d.content.length,endOffset:d.content.length}:f(a,e)}return null}function g(a,b){var c=a.kfEditor,d=(a.parentComponent,null);if(j(b))return null;for(d=c.requestService("position.get.parent.info",b);0===d.index;){if(j(d.group.groupObj))return{groupId:d.group.id,startOffset:0,endOffset:0};if(k(d.group.groupObj)&&d.group.content.length>1)return{groupId:d.group.id,startOffset:0,endOffset:0};d=c.requestService("position.get.parent.info",d.group.groupObj)}return b=d.group.content[d.index-1],l(b)?k(b)?f(a,b):f(a,b):n(b)?g(a,b):{groupId:d.group.id,startOffset:d.index,endOffset:d.index}}function h(a,b){var c=a.parentComponent,d=null,e=null;if(l(b)){if(d=c.getGroupContent(b.id),e=d.content[0],k(b))return k(e)?h(a,e):{groupId:b.id,startOffset:0,endOffset:0};for(;!k(e)&&!m(e)&&!n(e);)d=c.getGroupContent(e.id),e=d.content[0];return m(e)?{groupId:e.id,startOffset:0,endOffset:0}:n(e)?i(a,e):h(a,e)}return null}function i(a,b){var c=a.kfEditor,d=(a.parentComponent,null);if(j(b))return null;for(d=c.requestService("position.get.parent.info",b);d.index===d.group.content.length-1;){if(j(d.group.groupObj))return{groupId:d.group.id,startOffset:d.group.content.length,endOffset:d.group.content.length};if(k(d.group.groupObj)&&d.group.content.length>1)return{groupId:d.group.id,startOffset:d.group.content.length,endOffset:d.group.content.length};d=c.requestService("position.get.parent.info",d.group.groupObj)}return b=d.group.content[d.index+1],n(b)?i(a,b):k(b)?{groupId:b.id,startOffset:0,endOffset:0}:{groupId:d.group.id,startOffset:d.index+1,endOffset:d.index+1}}function j(a){return!!a.getAttribute("data-root")}function k(a){return"kf-editor-group"===a.getAttribute("data-type")}function l(a){var b=a.getAttribute("data-type");return"kf-editor-group"===b||"kf-editor-virtual-group"===b}function m(a){return!!a.getAttribute("data-placeholder")}function n(a){return"Empty"===a.getAttribute("data-flag")}var o=a("kity"),p={LEFT:"left",RIGHT:"right"};return o.createClass("MoveComponent",{constructor:function(a,b){this.parentComponent=a,this.kfEditor=b},leftMove:function(){var a=this.parentComponent.getCursorRecord();a=b.call(this,a),a&&this.parentComponent.updateCursor(a.groupId,a.startOffset,a.endOffset)},rightMove:function(){var a=this.parentComponent.getCursorRecord();a=c.call(this,a),a&&this.parentComponent.updateCursor(a.groupId,a.startOffset,a.endOffset)}})}),a("syntax/syntax",["kity","syntax/move"],function(a){var b=a("kity"),c=a("syntax/move"),d="",e=b.createClass("SyntaxComponenet",{constructor:function(a){this.kfEditor=a,this.record={cursor:{group:null,startOffset:-1,endOffset:-1}},this.components={},this.objTree=null,this.initComponents(),this.initServices()},initComponents:function(){this.components.move=new c(this,this.kfEditor)},initServices:function(){this.kfEditor.registerService("syntax.update.objtree",this,{updateObjTree:this.updateObjTree}),this.kfEditor.registerService("syntax.get.objtree",this,{getObjectTree:this.getObjectTree}),this.kfEditor.registerService("syntax.get.group.object",this,{getGroupObject:this.getGroupObject}),this.kfEditor.registerService("syntax.valid.placeholder",this,{isPlaceholder:this.isPlaceholder}),this.kfEditor.registerService("syntax.valid.brackets",this,{isBrackets:this.isBrackets}),this.kfEditor.registerService("syntax.get.group.content",this,{getGroupContent:this.getGroupContent}),this.kfEditor.registerService("syntax.update.record.cursor",this,{updateCursor:this.updateCursor}),this.kfEditor.registerService("syntax.update.selection",this,{updateSelection:this.updateSelection}),this.kfEditor.registerService("syntax.get.record.cursor",this,{getCursorRecord:this.getCursorRecord}),this.kfEditor.registerService("syntax.get.latex.info",this,{getLatexInfo:this.getLatexInfo}),this.kfEditor.registerService("syntax.insert.string",this,{insertString:this.insertString}),this.kfEditor.registerService("syntax.insert.group",this,{insertGroup:this.insertGroup}),this.kfEditor.registerService("syntax.serialization",this,{serialization:this.serialization}),this.kfEditor.registerService("syntax.cursor.move.left",this,{leftMove:this.leftMove}),this.kfEditor.registerService("syntax.cursor.move.right",this,{rightMove:this.rightMove})},updateObjTree:function(a){var b=a.select;b&&b.groupId&&this.updateCursor(b.groupId,b.startOffset,b.endOffset),this.objTree=a},isPlaceholder:function(a){return!!this.objTree.mapping[a].objGroup.node.getAttribute("data-placeholder")},isBrackets:function(a){return!!this.objTree.mapping[a].objGroup.node.getAttribute("data-brackets")},getObjectTree:function(){return this.objTree},getGroupObject:function(a){return this.objTree.mapping[a].objGroup||null},getCursorRecord:function(){return b.Utils.extend({},this.record.cursor)||null},getGroupContent:function(a){var c=this.objTree.mapping[a],d=[],e=c.objGroup.operands,f=e.length-1,g="rtl"!==c.strGroup.traversal;return b.Utils.each(e,function(a,b){g?d.push(a.node):d[f-b]=a.node}),{id:a,traversal:c.strGroup.traversal||"ltr",groupObj:c.objGroup.node,content:d}},updateSelection:function(a){var b=this.objTree.mapping[a.id],c=b.strGroup,e=null,f=null,g=null,h=-1,i=-1;if(e=a,f=b,"combination"===c.name)this.record.cursor={groupId:e.id,startOffset:0,endOffset:c.operand.length},c.operand.unshift(d),c.operand.push(d);else{for(;"combination"!==f.strGroup.name||1===e.content;)a=e,b=f,e=this.kfEditor.requestService("position.get.parent.group",b.objGroup.node),f=this.objTree.mapping[e.id];var j=[].indexOf.call(e.content,a.groupObj);this.record.cursor={groupId:e.id,startOffset:j,endOffset:j+1},f.strGroup.operand.splice(j+1,0,d),f.strGroup.operand.splice(j,0,d)}return g=this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree),h=g.indexOf(d),g=g.replace(d,""),i=g.indexOf(d),f.strGroup.operand.splice(this.record.cursor.startOffset,1),f.strGroup.operand.splice(this.record.cursor.endOffset,1),{str:g,startOffset:h,endOffset:i}},getLatexInfo:function(){var a=this.record.cursor,b=this.objTree.mapping[a.groupId],c=b.strGroup,e=null,f=-1,g=-1,h=!!c.attr["data-placeholder"];return f=Math.min(a.endOffset,a.startOffset),g=Math.max(a.endOffset,a.startOffset),h?(c=this.kfEditor.requestService("position.get.parent.group",b.objGroup.node),c=this.objTree.mapping[c.id].strGroup,c.operand.unshift(d),c.operand.push(d)):(c.operand.splice(g,0,d),c.operand.splice(f,0,d),g+=1),e=this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree),h?(c.operand.shift(),c.operand.pop()):(c.operand.splice(g,1),c.operand.splice(f,1)),f=e.indexOf(d),e=e.replace(d,""),g=e.lastIndexOf(d),{str:e,startOffset:f,endOffset:g}},updateCursor:function(a,b,c){void 0===c&&(c=b),this.record.cursor={groupId:a,startOffset:b,endOffset:c},window.tt=this.record.cursor},serialization:function(){return this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree)},insertGroup:function(a){var b=this.kfEditor.requestService("parser.parse",a),c=b.tree;this.insertSubtree(c)},leftMove:function(){this.components.move.leftMove()},rightMove:function(){this.components.move.rightMove()},insertSubtree:function(a){var b=this.record.cursor,c=0,d=0,e=null,f=0;this.isPlaceholder(b.groupId)?this.replaceTree(a):(c=Math.min(b.startOffset,b.endOffset),d=Math.max(b.startOffset,b.endOffset),f=d-c,e=this.objTree.mapping[b.groupId].strGroup,e.operand.splice(c,f,a),b.startOffset+=1,b.endOffset=b.startOffset)},replaceTree:function(a){var b=this.record.cursor,c=this.objTree.mapping[b.groupId].objGroup.node,d=this.kfEditor.requestService("position.get.parent.info",c),e=this.objTree.mapping[d.group.id].strGroup;e.operand[d.index]=a,b.groupId=d.group.id,b.startOffset=d.index+1,b.endOffset=d.index+1}});return e}),a("ui/control/zoom",["base/utils","base/common","base/event/event","kity"],function(a){var b=a("base/utils"),c=a("kity"),d={min:.5,max:5},e=c.createClass("ScrollZoomController",{constructor:function(a,c,e,f){this.kfEditor=c,this.target=e,this.zoom=1,this.step=.05,this.options=b.extend({},d,f),this.initEvent()},initEvent:function(){var a=this.kfEditor,c=this,d=this.options.min,e=this.options.max,f=this.step;b.addEvent(this.target,"mousewheel",function(b){b.preventDefault(),b.wheelDelta<0?c.zoom-=c.zoom*f:c.zoom+=c.zoom*f,c.zoom=Math.max(c.zoom,d),c.zoom=Math.min(c.zoom,e),a.requestService("render.set.canvas.zoom",c.zoom)})}});return e}),a("ui/toolbar-ele-list",["ui/ui-impl/def/ele-type"],function(a){var b=a("ui/ui-impl/def/ele-type");return[{type:b.DRAPDOWN_BOX,options:{button:{label:"预设",icon:"assets/images/toolbar/button/pi.png"},box:{group:[{title:"预设公式",content:[{label:"二次公式",item:{show:'<img src="assets/images/toolbar/ys/1.png">',val:"x=\\frac {-b\\pm\\sqrt {b^2-4ac}}{2a}"}},{label:"二项式定理",item:{show:'<img src="assets/images/toolbar/ys/2.png">',val:"{\\left(x+a\\right)}^2=\\sum^n_{k=0}{\\left(^n_k\\right)x^ka^{n-k}}"}},{label:"勾股定理",item:{show:'<img src="assets/images/toolbar/ys/3.png">',val:"a^2+b^2=c^2"}}]}]}}},{type:b.DELIMITER},{type:b.DRAPDOWN_BOX,options:{button:{label:"分数",icon:"assets/images/toolbar/button/frac.png"},box:{width:378,group:[{title:"分数",content:[{item:{show:'<img src="assets/images/toolbar/frac/1.png">',val:"\\frac \\placeholder\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/frac/2.png">',val:"\\placeholder/\\placeholder"}}]},{title:"常用分数",content:[{item:{show:'<img src="assets/images/toolbar/frac/c1.png">',val:"\\frac {dy}{dx}"}},{item:{show:'<img src="assets/images/toolbar/frac/c2.png">',val:"\\frac {\\Delta y}{\\Delta x}"}},{item:{show:'<img src="assets/images/toolbar/frac/c4.png">',val:"\\frac {\\delta y}{\\delta x}"}},{item:{show:'<img src="assets/images/toolbar/frac/c5.png">',val:"\\frac \\pi 2"}}]}]}}},{type:b.DRAPDOWN_BOX,options:{button:{label:"上下标",icon:"assets/images/toolbar/button/script.png"},box:{width:378,group:[{title:"上标和下标",content:[{item:{show:'<img src="assets/images/toolbar/script/1.png">',val:"\\placeholder^\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/script/2.png">',val:"\\placeholder_\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/script/3.png">',val:"\\placeholder^\\placeholder_\\placeholder"}},{item:{show:'<img src="assets/images/toolbar/script/4.png">',val:"^\\placeholder_\\placeholder\\placeholder"}}]},{title:"常用的上标和下标",content:[{item:{show:'<img src="assets/images/toolbar/script/c1.png">',val:"e^{-i\\omega t}"}},{item:{show:'<img src="assets/images/toolbar/script/c2.png">',val:"x^2"}},{item:{show:'<img src="assets/images/toolbar/script/c3.png">',val:"^n_1Y"}}]}]}}},{type:b.DRAPDOWN_BOX,options:{button:{label:"根式",icon:"assets/images/toolbar/button/sqrt.png"},box:{width:378,group:[{title:"根式",content:[{item:{show:'<img src="assets/images/toolbar/sqrt/1.png">',val:"\\sqrt \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/sqrt/2.png">',val:"\\sqrt [\\placeholder] \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/sqrt/3.png">',val:"\\sqrt [2] \\placeholder"}},{item:{show:'<img src="assets/images/toolbar/sqrt/4.png">',val:"\\sqrt [3] \\placeholder"}}]},{title:"常用根式",content:[{item:{show:'<img src="assets/images/toolbar/sqrt/c1.png">',val:"\\frac {-b\\pm\\sqrt{b^2-4ac}}{2a}"}},{item:{show:'<img src="assets/images/toolbar/sqrt/c2.png">',val:"\\sqrt {a^2+b^2}"}}]}]}}},{type:b.DRAPDOWN_BOX,options:{button:{label:"括号",icon:"assets/images/toolbar/button/brackets.png"},box:{width:378,group:[{title:"方括号",content:[{item:{show:'<img src="assets/images/toolbar/brackets/1.png">',val:"\\left(\\placeholder\\right)"}},{item:{show:'<img src="assets/images/toolbar/brackets/2.png">',val:"\\left[\\placeholder\\right]"}},{item:{show:'<img src="assets/images/toolbar/brackets/3.png">',val:"\\left\\{\\placeholder\\right\\}"}},{item:{show:'<img src="assets/images/toolbar/brackets/4.png">',val:"\\left|\\placeholder\\right|"}}]}]}}}]}),a("ui/toolbar/toolbar",["kity","ui/ui-impl/ui","ui/ui-impl/drapdown-box","ui/ui-impl/delimiter","ui/ui-impl/ui-utils","jquery","ui/ui-impl/def/ele-type"],function(a){function b(a,b,e){switch(a){case h.DRAPDOWN_BOX:return c(b,e);case h.DELIMITER:return d(b)}}function c(a,b){return new f.DrapdownBox(a,b)}function d(a){return new f.Delimiter(a)}var e=a("kity"),f=a("ui/ui-impl/ui"),g=a("ui/ui-impl/ui-utils"),h=a("ui/ui-impl/def/ele-type"),i=e.createClass("Tollbar",{constructor:function(a,b,c){this.kfEditor=a,this.uiComponent=b,this.elementList=c,this.elements=[],this.initToolbarElements(),this.initEvent()},initEvent:function(){var a=this;g.on(this.kfEditor.getContainer(),"mousedown",function(){a.notify("closeAll")}),g.subscribe("data.select",function(b){a.insertSource(b)})},insertSource:function(a){this.kfEditor.requestService("control.insert.group",a)},notify:function(a){switch(a){case"closeAll":case"closeOther":return void this.closeElement(arguments[1])}},closeElement:function(a){e.Utils.each(this.elements,function(b){b!=a&&b.hide&&b.hide()})},initToolbarElements:function(){var a=this.elements,c=this.uiComponent.toolbarContainer.ownerDocument,d=this;e.Utils.each(this.elementList,function(e){var f=b(e.type,c,e.options);a.push(f),d.appendElement(f)})},appendElement:function(a){a.setToolbar(this),a.attachTo(this.uiComponent.toolbarContainer)}});return i}),a("ui/ui-impl/box",["kity","ui/ui-impl/ui-utils","jquery"],function(a){function b(a,b){var d=[];return c.Utils.each(b,function(b){d.push(new g(a,b))}),d}var c=a("kity"),d="kf-editor-ui-",e=a("ui/ui-impl/ui-utils"),f=c.createClass("Box",{constructor:function(a,b){this.options=b,this.doc=a,this.element=this.createBox(),this.groupContainer=this.createGroupContainer(),this.itemGroups=this.createItemGroup(),this.mergeElement()},createBox:function(){var a=e.ele(this.doc,"div",{className:d+"box"});return"width"in this.options&&(a.style.width=this.options.width+"px"),a},initEvent:function(){var a="."+d+"box-item",b=this;e.delegate(this.groupContainer,a,"mousedown",function(a){a.preventDefault(),1===a.which&&b.onselectHandler&&b.onselectHandler(this.getAttribute("data-value"))}),e.on(this.element,"mousedown",function(a){a.stopPropagation(),a.preventDefault()})},getNode:function(){return this.element},setSelectHandler:function(a){this.onselectHandler=a},createGroupContainer:function(){return e.ele(this.doc,"div",{className:d+"box-container"})},createItemGroup:function(){var a=this.doc,f=[],g=null,h=null,i=null;return g=e.ele(this.doc,"div",{className:d+"box-group"}),i=g.cloneNode(!1),i.className=d+"box-group-item-container",c.Utils.each(this.options.group,function(j){g=g.cloneNode(!1),i=i.cloneNode(!1),h=e.ele(a,"div",{className:d+"box-group-title",content:j.title}),g.appendChild(h),g.appendChild(i),c.Utils.each(b(a,j.content),function(a){a.appendTo(i)}),f.push(g)}),f},mergeElement:function(){var a=this.groupContainer;this.element.appendChild(a),c.Utils.each(this.itemGroups,function(b){a.appendChild(b)})},mountTo:function(a){a.appendChild(this.element)},appendTo:function(a){a.appendChild(this.element)}}),g=c.createClass("BoxItem",{constructor:function(a,b){this.doc=a,this.options=b,this.element=this.createItem(),this.labelNode=this.createLabel(),this.contentNode=this.createContent(),this.mergeElement()},getNode:function(){return this.element},createItem:function(){var a=e.ele(this.doc,"div",{className:d+"box-item"});return a},createLabel:function(){var a=null;if("label"in this.options)return a=e.ele(this.doc,"div",{className:d+"box-item-label",content:this.options.label})},createContent:function(){var a=this.doc,b=e.ele(a,"div",{className:d+"box-item-content"}),c=d+"box-item-val",f=this.options.item,g=null;return"string"==typeof f&&(f={show:f,val:f}),g=e.ele(a,"div",{className:c}),g.innerHTML=f.show,this.element.setAttribute("data-value",f.val),b.appendChild(g),b},mergeElement:function(){this.labelNode&&this.element.appendChild(this.labelNode),this.element.appendChild(this.contentNode)},appendTo:function(a){a.appendChild(this.element)}});return f}),a("ui/ui-impl/button",["kity","ui/ui-impl/ui-utils","jquery"],function(a){var b=a("kity"),c="kf-editor-ui-",d=a("ui/ui-impl/ui-utils"),e=b.createClass("Button",{constructor:function(a,b){this.options=b,this.eventState=!1,this.doc=a,this.element=this.createButton(),this.icon=this.createIcon(),this.label=this.createLabel(),this.sign=this.createSign(),this.mountPoint=this.createMountPoint(),this.mergeElement()},initEvent:function(){var a=this;this.eventState||(this.eventState=!0,d.on(this.element,"mousedown",function(b){b.preventDefault(),b.stopPropagation(),1===b.which&&(a.toggleSelect(),a.toggleMountElement())
}))},toggleMountElement:function(){var a=this.mountPoint.style.display||"none";this.mountPoint.style.display="none"===a?"block":"none"},toggleSelect:function(){this.element.classList.toggle(c+"button-in")},unselect:function(){this.element.classList.remove(c+"button-in")},select:function(){this.element.classList.add(c+"button-in")},show:function(){this.select(),this.showMount()},hide:function(){this.unselect(),this.hideMount()},showMount:function(){this.mountPoint.style.display="block"},hideMount:function(){this.mountPoint.style.display="none"},getNode:function(){return this.element},mount:function(a){a.mountTo(this.mountPoint)},createButton:function(){var a=d.ele(this.doc,"div",{className:c+"button"});return a},createIcon:function(){var a=d.ele(this.doc,"div",{className:c+"button-icon"});return a.style.backgroundImage="url("+this.options.icon+")",a},createLabel:function(){var a=d.ele(this.doc,"div",{className:c+"button-label",content:this.options.label});return a},createSign:function(){return d.ele(this.doc,"div",{className:c+"button-sign"})},createMountPoint:function(){return d.ele(this.doc,"div",{className:c+"button-mount-point"})},mergeElement:function(){this.element.appendChild(this.icon),this.element.appendChild(this.label),this.element.appendChild(this.sign),this.element.appendChild(this.mountPoint)}});return e}),a("ui/ui-impl/def/ele-type",[],function(){return{DRAPDOWN_BOX:1,DELIMITER:2}}),a("ui/ui-impl/delimiter",["kity","ui/ui-impl/ui-utils","jquery"],function(a){var b=a("kity"),c="kf-editor-ui-",d=a("ui/ui-impl/ui-utils"),e=b.createClass("Delimiter",{constructor:function(a){this.doc=a,this.element=this.createDilimiter()},setToolbar:function(){},createDilimiter:function(){var a=d.ele(this.doc,"div",{className:c+"delimiter"});return a.appendChild(d.ele(this.doc,"div",{className:c+"delimiter-line"})),a},attachTo:function(a){a.appendChild(this.element)}});return e}),a("ui/ui-impl/drapdown-box",["kity","ui/ui-impl/ui-utils","jquery","ui/ui-impl/button","ui/ui-impl/box"],function(a){var b=a("kity"),c=a("ui/ui-impl/ui-utils"),d=a("ui/ui-impl/button"),e=a("ui/ui-impl/box"),f=b.createClass("DrapdownBox",{constructor:function(a,b){this.options=b,this.toolbar=null,this.doc=a,this.buttonElement=this.createButton(),this.element=this.buttonElement.getNode(),this.boxElement=this.createBox(),this.buttonElement.mount(this.boxElement),this.initEvent()},initEvent:function(){var a=this;c.on(this.element,"mousedown",function(b){b.preventDefault(),b.stopPropagation(),a.toolbar.notify("closeOther",a)}),this.buttonElement.initEvent(),this.boxElement.initEvent(),this.boxElement.setSelectHandler(function(b){c.publish("data.select",b),a.buttonElement.hide()})},setToolbar:function(a){this.toolbar=a},createButton:function(){return new d(this.doc,this.options.button)},show:function(){this.buttonElement.show()},hide:function(){this.buttonElement.hide()},createBox:function(){return new e(this.doc,this.options.box)},attachTo:function(a){a.appendChild(this.element)}});return f}),a("ui/ui-impl/ui-utils",["jquery","kity"],function(a){var b=a("jquery"),c=a("kity"),d={};return{ele:function(a,b,c){var d=a.createElement(b);return c.className&&(d.className=c.className),c.content&&(d.innerHTML=c.content),d},on:function(a,c,d){return b(a).on(c,d),this},delegate:function(a,c,d,e){return b(a).delegate(c,d,e),this},publish:function(a,b){var e=d[a];e&&(b=[].slice.call(arguments,1),c.Utils.each(e,function(a){a.apply(null,b)}))},subscribe:function(a,b){d[a]||(d[a]=[]),d[a].push(b)}}}),a("ui/ui-impl/ui",["ui/ui-impl/drapdown-box","kity","ui/ui-impl/ui-utils","ui/ui-impl/button","ui/ui-impl/box","ui/ui-impl/delimiter"],function(a){return{DrapdownBox:a("ui/ui-impl/drapdown-box"),Delimiter:a("ui/ui-impl/delimiter")}}),a("ui/ui",["kity","base/utils","base/common","base/event/event","ui/toolbar/toolbar","ui/ui-impl/ui","ui/ui-impl/ui-utils","ui/ui-impl/def/ele-type","ui/control/zoom","ui/toolbar-ele-list"],function(a){function b(a){var b=a.createElement("div");return b.className="kf-editor-toolbar",b}function c(a){var b=a.createElement("div");return b.className="kf-editor-edit-area",b.style.width="80%",b.style.height="800px",b}function d(a){var b=a.createElement("div");return b.className="kf-editor-canvas-container",b}var e=a("kity"),f=a("base/utils"),g=a("ui/toolbar/toolbar"),h=a("ui/control/zoom"),i=a("ui/toolbar-ele-list"),j=e.createClass("UIComponent",{constructor:function(a){var e=null;this.container=a.getContainer(),e=this.container.ownerDocument,this.components={},this.kfEditor=a,this.resizeTimer=null,this.toolbarContainer=b(e),this.editArea=c(e),this.canvasContainer=d(e),this.updateContainerSize(this.container,this.toolbarContainer,this.editArea,this.canvasContainer),this.container.appendChild(this.toolbarContainer),this.editArea.appendChild(this.canvasContainer),this.container.appendChild(this.editArea),this.initCanvas(),this.initComponents(),this.initServices(),this.initResizeEvent()},initComponents:function(){this.components.toolbar=new g(this.kfEditor,this,i),this.components.scrollZoom=new h(this,this.kfEditor,this.canvasContainer)},initCanvas:function(){},updateContainerSize:function(a,b,c){var d=a.getBoundingClientRect();b.style.width=d.width-12+"px",b.style.height="80px",c.style.marginTop="80px",c.style.width=d.width+"px",c.style.height=d.height-80+"px"},initServices:function(){this.kfEditor.registerService("ui.get.canvas.container",this,{getCanvasContainer:k.getCanvasContainer}),this.kfEditor.registerService("ui.canvas.container.event",this,{on:k.addEvent,off:k.removeEvent,trigger:k.trigger,fire:k.trigger})},initResizeEvent:function(){var a=this;this.canvasContainer.ownerDocument.defaultView.onresize=function(){window.clearTimeout(a.resizeTimer),a.resizeTimer=window.setTimeout(function(){a.kfEditor.requestService("render.relocation")},80)}}}),k={getCanvasContainer:function(){return this.canvasContainer},addEvent:function(a,b){f.addEvent(this.canvasContainer,a,b)},removeEvent:function(){},trigger:function(a){f.trigger(this.canvasContainer,a)}};return j}),function(){a("kf.start",function(a){var b=a("editor/editor");b.registerComponents("ui",a("ui/ui")),b.registerComponents("parser",a("parse/parser")),b.registerComponents("render",a("render/render")),b.registerComponents("position",a("position/position")),b.registerComponents("syntax",a("syntax/syntax")),kf.Editor=b});try{c("kf.start")}catch(b){}}(this)}();